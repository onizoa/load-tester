<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xtime Module</title>
    <link rel="icon" type="image/png" href="./images/STH icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // <--- ENSURE THIS LINE IS HERE
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#f59e0b',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>


    <link rel="stylesheet" href="./components/xtime-style.css">
    <link rel="stylesheet" href="./components/xtime-assessment-style.css">

    <script>
            // PRE-LOAD THEME CHECK
            (function () {
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                    document.documentElement.classList.add('dark');
                }
            })();
    </script>

</head>

<body class="font-inter bg-white text-gray-900 flex flex-col min-h-screen">

    <div id="header-container"></div>

    <div id="splash-screen"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-white dark:bg-zinc-950 transition-opacity duration-700">
        <div class="flex flex-col items-center">
            <div class="mb-4">
                <span class="text-2xl font-bold">
                    <span class="text-indigo-600">Scheduler</span><span class="text-amber-500">TrainingHub</span>
                </span>
            </div>
            <div class="w-12 h-12 border-4 border-indigo-600/20 border-t-indigo-600 rounded-full animate-spin"></div>

            <p class="mt-4 text-sm font-medium text-zinc-500 dark:text-zinc-400 animate-pulse">
                Loading Xtime...
            </p>
        </div>
    </div>

    <main class="flex-grow">

        <section class="relative overflow-hidden">
            <div
                class="absolute inset-0 bg-gradient-to-r from-primary/20 to-secondary/20 -skew-y-3 transform origin-top-left">
            </div>
            <div class="container mx-auto px-6 py-28 relative z-10">
                <div class="max-w-3xl mx-auto text-center">
                    <div class="inline-block mb-6 px-4 py-2 bg-white rounded-full shadow-md">
                        <span class="text-sm font-semibold text-primary">Xtime Module</span>
                    </div>
                    <h1 class="text-5xl md:text-6xl font-bold mb-4 leading-tight">
                        <span
                            class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary font-extrabold">Master</span>
                        the Scheduler
                    </h1>
                    <div class="flex justify-center items-center text-gray-600 mb-8 font-medium">
                        <i data-feather="clock" class="w-4 h-4 mr-1 text-secondary"></i>
                        <span>Approximate Time: 35 min</span>
                    </div>
                    <p class="text-xl text-gray-600 max-w-2xl mx-auto mb-16">
                        Learn the complete Xtime appointment flow through interactive elements and visual storytelling.
                    </p>
                </div>
            </div>
        </section>

        <section class="py-20" id="booking-flow">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="text-3xl font-bold mb-4">Appointment Booking Flow</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">Follow the journey from customer search to final
                        confirmation</p>
                </div>

                <div class="timeline-container relative">
                    <div
                        class="absolute left-1/2 h-full w-1 bg-gradient-to-b from-primary to-secondary transform -translate-x-1/2">
                    </div>

                    <div class="grid grid-cols-1 gap-8">
                        <div class="timeline-row grid md:grid-cols-2 gap-8">
                            <div class="timeline-card left" data-aos="fade-right">
                                <div class="timeline-content">
                                    <div class="timeline-number">1</div>
                                    <div class="timeline-details">
                                        <h3 class="text-xl font-bold mb-2">Search Customer</h3>
                                        <p class="text-gray-600">Begin by locating the customer in the system using
                                            name, phone, or email.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-card right" data-aos="fade-left" data-aos-delay="100">
                                <div class="timeline-content">
                                    <div class="timeline-number">2</div>
                                    <div class="timeline-details">
                                        <h3 class="text-xl font-bold mb-2">Select Vehicle</h3>
                                        <p class="text-gray-600">Choose the correct vehicle from the customer's profile
                                            or add a new one.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="timeline-row grid md:grid-cols-2 gap-8">
                            <div class="timeline-card left" data-aos="fade-right" data-aos-delay="200">
                                <div class="timeline-content">
                                    <div class="timeline-number">3</div>
                                    <div class="timeline-details">
                                        <h3 class="text-xl font-bold mb-2">Add Services</h3>
                                        <p class="text-gray-600">Select the required services from the menu or create
                                            custom service requests.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-card right" data-aos="fade-left" data-aos-delay="300">
                                <div class="timeline-content">
                                    <div class="timeline-number">4</div>
                                    <div class="timeline-details">
                                        <h3 class="text-xl font-bold mb-2">Pick Advisor & Transportation</h3>
                                        <p class="text-gray-600">Assign a service advisor and select transportation
                                            options if needed.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="timeline-row grid md:grid-cols-2 gap-8">
                            <div class="timeline-card left" data-aos="fade-right" data-aos-delay="400">
                                <div class="timeline-content">
                                    <div class="timeline-number">5</div>
                                    <div class="timeline-details">
                                        <h3 class="text-xl font-bold mb-2">Pick Date & Time</h3>
                                        <p class="text-gray-600">Choose an available time slot that works for both the
                                            shop and customer.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-card right" data-aos="fade-left" data-aos-delay="500">
                                <div class="timeline-content">
                                    <div class="timeline-number">6</div>
                                    <div class="timeline-details">
                                        <h3 class="text-xl font-bold mb-2">Confirm</h3>
                                        <p class="text-gray-600">Review all details and finalize the appointment with
                                            the customer.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-20 bg-gradient-to-r from-primary to-secondary">
            <div class="container mx-auto px-6 text-center">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Video tutorials</h2>
                    <p class="text-white/90 mb-2">Short, focused videos covering key workflows.</p>
                    <div class="flex justify-center items-center text-white mb-8">
                        <i data-feather="clock" class="w-4 h-4 mr-1 text-secondary"></i>
                        <span>Approximate Time: 10 min</span>
                    </div>
                    <button id="openPlayer"
                        class="inline-block px-8 py-4 bg-white text-primary font-bold rounded-full shadow-lg hover:bg-gray-100 transition transform hover:-translate-y-1 hover:shadow-xl">
                        Start Watching
                    </button>
                </div>
            </div>
        </section>

        <section class="py-20 bg-gray-50" id="shops">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="text-3xl font-bold mb-4">Service Shop Types</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">Understanding the different shop configurations and their
                        purposes
                    </p>
                </div>

                <div class="grid md:grid-cols-3 gap-8">

                    <div class="shop-card" data-aos="fade-up">
                        <div class="shop-icon bg-primary/10">
                            <i data-feather="zap" class="text-primary"></i>
                        </div>
                        <h3 class="shop-title text-primary">Express Shop</h3>
                        <p class="shop-description">Handles <strong>Regular Maintenance</strong> such as Oil Changes,
                            Tire
                            rotations, Cabin Air Filter replacement, Engine Air Filter replacement, etc.</p>
                        <div class="shop-tag">Quick Service</div>
                    </div>

                    <div class="shop-card" data-aos="fade-up" data-aos-delay="100">
                        <div class="shop-icon bg-primary/10">
                            <i data-feather="tool" class="text-primary"></i>
                        </div>
                        <h3 class="shop-title text-primary">Main Shop</h3>
                        <p class="shop-description">Dedicated to any type of <strong>Diagnostic</strong> or
                            <strong>Heavy/Major
                                Repair</strong>, and all <strong>Recalls</strong>.
                        </p>
                        <div class="shop-tag">Complex Repairs</div>
                    </div>

                    <div class="shop-card" data-aos="fade-up" data-aos-delay="200">
                        <div class="shop-icon bg-primary/10">
                            <i data-feather="truck" class="text-primary"></i>
                        </div>
                        <h3 class="shop-title text-primary">Body Shop</h3>
                        <p class="shop-description">A certified location for collision repairs, dents, paint missing,
                            and
                            frame/chassis work.</p>
                        <div class="shop-tag">Collision Center</div>
                    </div>

                </div>
            </div>
        </section>

        <section class="py-20" id="transportation">
            <div class="container mx-auto px-8">
                <div class="text-center mb-16">
                    <h2 class="text-3xl font-bold mb-4">Transportation Options</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">Various ways to accommodate customers during service
                        visits</p>
                </div>

                <div class="transportation-grid">
                    <div class="transportation-card" data-aos="fade-up">
                        <div class="transportation-content">
                            <h3 class="transportation-title">Shuttle</h3>
                            <p class="transportation-description">Generally a service provided by the service department
                                to cater the
                                customer home, or to a business while their vehicle is being worked on.</p>
                        </div>
                    </div>

                    <div class="transportation-card" data-aos="fade-up" data-aos-delay="50">
                        <div class="transportation-content">
                            <h3 class="transportation-title">Loaner</h3>
                            <p class="transportation-description">Temporary replacement vehicle paid by
                                <strong>Warranty</strong> to
                                accommodate a customer for the inconvenience of bringing in their vehicle for repairs.
                            </p>
                        </div>
                    </div>

                    <div class="transportation-card" data-aos="fade-up" data-aos-delay="100">
                        <div class="transportation-content">
                            <h3 class="transportation-title">Rental</h3>
                            <p class="transportation-description">Temporary replacement vehicles for repairs during a
                                service that are
                                paid for <strong>by the customer</strong>.</p>
                        </div>
                    </div>

                    <div class="transportation-card" data-aos="fade-up" data-aos-delay="150">
                        <div class="transportation-content">
                            <h3 class="transportation-title">Valet</h3>
                            <p class="transportation-description">When two advisors (or representatives) use a company
                                vehicle to pick
                                up the customer's vehicle at their house for service.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-20 bg-gradient-to-r from-primary to-secondary">
            <div class="container mx-auto px-6 text-center">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Ready to Test Your Knowledge?</h2>
                    <p class="text-white/90 mb-8">You've mastered the Xtime fundamentals. Click below to take the final
                        assessment.</p>
                    <button id="openAssessment"
                        class="inline-block px-8 py-4 bg-white text-primary font-bold rounded-full shadow-lg hover:bg-gray-100 transition transform hover:-translate-y-1 hover:shadow-xl">
                        Start Assessment
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-container"></div>

    <div class="video-overlay" id="overlay">
        <div class="video-player">

            <aside class="playlist">
                <h3>Video Playlist</h3>

                <div class="video-item active" data-src="./videos/Xtime-login.mp4">
                    Xtime Login
                    <span>Length 00:23</span>
                </div>

                <div class="video-item" data-src="./videos/Dealership Selection.mp4">
                    Dealership Selection
                    <span>Length 00:14</span>
                </div>

                <div class="video-item" data-src="./videos/Add new customer.mp4">
                    New Customer
                    <span>Length 00:35</span>
                </div>

                <div class="video-item" data-src="./videos/New Appt.mp4">
                    New Appointment
                    <span>Length 02:41</span>
                </div>

                <div class="video-item" data-src="./videos/Resched-appt.mp4">
                    Reschedule Appointment
                    <span>Length 0:45</span>
                </div>

                <div class="video-item" data-src="./videos/Cancel-appt.mp4">
                    Cancel Appointment
                    <span>Length 0:30</span>
                </div>

                <div class="video-item" data-src="./videos/DMS-appt.mp4">
                    DMS Appointment
                    <span>Length 0:42</span>
                </div>

                <div class="video-item" data-src="./videos/Add new vehicle.mp4">
                    Add Vehicle
                    <span>Length 0:49</span>
                </div>

                <div class="video-item" data-src="./videos/Remove vehicle.mp4">
                    Remove Vehicle
                    <span>Length 0:38</span>
                </div>

                <div class="video-item" data-src="./videos/RO-history.mp4">
                    RO history
                    <span>Length 0:34</span>
                </div>

                <div class="video-item" data-src="./videos/Workbook.mp4">
                    Workbook
                    <span>Length 0:32</span>
                </div>
            </aside>

            <div class="player-main">
                <div class="player-header">
                    <button class="close-btn" id="closePlayer">
                        <i data-feather="x"></i>
                    </button>
                </div>

                <video id="video" src="./videos/Xtime-login.mp4"></video>

                <div class="controls">
                    <button id="playPause"><i data-feather="play"></i></button>

                    <div class="progress" id="progress">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <span class="time-display text-xs" id="timeDisplay">00:00 / 00:00</span>

                    <button id="mute"><i data-feather="volume-2"></i></button>
                    <button id="fullscreen"><i data-feather="maximize-2"></i></button>
                </div>
            </div>

        </div>

        <div class="custom-modal-overlay hidden" id="warningModal">
            <div class="custom-modal-content">
                <h4 class="text-lg font-semibold text-gray-800">Video Access Blocked</h4>
                <p class="text-gray-600 mt-2">Please finish the previous video before moving to this one.</p>
                <button class="modal-close-btn bg-primary text-white hover:bg-primary/90 transition-colors"
                    id="closeWarningModal">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!--Assessment overlay placeholder-->
    <div class="assessment-overlay" id="assessment-overlay">
        <div class="assessment-container">
            <aside class="assessment-sidebar">
                <h3 class="text-white font-bold mb-4">Progress</h3>
                <div id="sidebar-nav"></div>
            </aside>

            <div class="assessment-main" id="quiz-ui">
                <button class="close-btn" id="closeAssessment">
                    <i data-feather="x"></i>
                </button>

                <div id="question-content">
                    <div class="quiz-header flex flex-wrap items-center gap-3 mb-6">
                        <button class="sidebar-toggle-btn shadow-sm" id="toggleSidebar">
                            <i data-feather="menu"></i>
                        </button>
                        <span id="step-indicator"
                            class="px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-bold rounded-full uppercase">
                            Question 1 of 30
                        </span>
                    </div>

                    <h2 id="question-text" class="text-2xl font-bold text-gray-800 mb-8 leading-snug"></h2>
                    <div id="options-grid" class="space-y-3"></div>
                </div>

                <div class="mt-auto pt-8 border-t border-gray-100 flex justify-between items-center bg-white">
                    <button id="prev-btn"
                        class="px-6 py-3 font-semibold text-gray-400 hover:text-gray-600 disabled:opacity-30 transition-colors">
                        Previous
                    </button>
                    <button id="action-btn"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:shadow-indigo-200 transition transform hover:-translate-y-0.5">
                        Next Question
                    </button>
                </div>
            </div>

            <div class="assessment-main hidden text-center justify-center" id="results-ui"></div>
        </div>
    </div>

    <div id="warning-modal" class="hidden fixed inset-0 bg-black/50 z-[1100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <div
                class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-feather="alert-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Incomplete Assessment</h3>
            <p class="text-gray-500 mb-6">Please complete all 30 questions before finishing the test.</p>
            <button id="closeWarningBtn"
                class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-gray-800 transition">
                Return to Test
            </button>
        </div>
    </div>
    <!-- END of Assessment overlay placeholder-->

    <!--Dealership Shop Tooltip-->
    <div id="shop-modal"
        class="fixed inset-0 z-[1200] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-zinc-900 w-full max-w-2xl p-8 rounded-2xl shadow-2xl mx-4 max-h-[90vh] overflow-y-auto">

            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="modal-shop-title" class="text-2xl font-bold text-primary uppercase tracking-wide"></h3>
                <button id="close-shop-modal" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Select Dealership
                    Policy</label>
                <div class="relative">
                    <button type="button" id="dealer-menu-button"
                        class="w-full flex items-center justify-between p-4 border border-gray-200 rounded-xl bg-gray-50 dark:bg-zinc-800 dark:border-zinc-700 cursor-pointer hover:bg-neutral-100 dark:hover:bg-zinc-700 transition-all focus:ring-2 focus:ring-primary focus:outline-none">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
                            <span id="current-dealer-text"
                                class="text-sm font-semibold text-neutral-700 dark:text-zinc-200">Hudson Honda</span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor"
                            stroke-width="2.5" viewBox="0 0 24 24"
                            class="text-neutral-400 transition-transform duration-300" id="dealer-chevron">
                            <path d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>

                    <div id="dealer-dropdown"
                        class="hidden absolute left-0 top-full mt-2 w-full bg-white dark:bg-zinc-900 border border-neutral-200 dark:border-zinc-800 rounded-2xl shadow-2xl z-[1300] overflow-hidden">
                        <div class="p-2 space-y-1">
                            <button
                                class="dealer-option w-full flex items-center justify-between px-4 py-3 text-sm font-medium text-neutral-700 dark:text-zinc-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-xl transition-colors group"
                                data-value="Hudson Honda">
                                <span>Hudson Honda</span>
                                <i data-feather="check"
                                    class="w-4 h-4 opacity-0 group-hover:opacity-100 text-primary transition-opacity"></i>
                            </button>
                            <button
                                class="dealer-option w-full flex items-center justify-between px-4 py-3 text-sm font-medium text-neutral-700 dark:text-zinc-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-xl transition-colors group"
                                data-value="Toyota Global">
                                <span>Toyota Global</span>
                                <i data-feather="check"
                                    class="w-4 h-4 opacity-0 group-hover:opacity-100 text-primary transition-opacity"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-50 dark:bg-zinc-800/50 rounded-2xl border border-gray-100 dark:border-zinc-700">
                <div id="modal-shop-description"
                    class="text-gray-700 dark:text-zinc-300 whitespace-pre-line leading-relaxed text-sm">
                </div>
            </div>
        </div>
    </div>
    <!-- END of Dealership Shop Tooltip-->

    <script src="./components/xtime-script.js"></script>

    <script type="module">
        import { auth, db } from "./components/firebase-init.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeModuleHeader } from "./components/module-header.js";
        import { initializeFooter } from "./components/footer.js";
        import { initializeTheme } from "./components/theme-manager.js";
        import { initializeLogout } from "./components/logout.js";


        // 1. Initialize Components
        initializeModuleHeader();
        initializeTheme();
        initializeFooter();
        initializeLogout();

        // 2. Dropdown Toggle Logic (The missing piece)
        // This script listens for clicks on the profile trigger and shows/hides the menu
        document.addEventListener('click', (e) => {
            const trigger = document.getElementById('user-menu-button'); // ID used in module-header
            const dropdown = document.getElementById('profile-dropdown');

            if (trigger && trigger.contains(e.target)) {
                dropdown.classList.toggle('hidden');
            } else if (dropdown && !dropdown.contains(e.target)) {
                // Close dropdown if user clicks anywhere else
                dropdown.classList.add('hidden');
            }
        });

        // 3. Listen for Auth State to populate user data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();

                    // Populate Header Indicators
                    // Note: Optional chaining (?.) prevents errors if an element is missing
                    const firstNameEl = document.getElementById('user-first-name');
                    const initialsEl = document.getElementById('user-initials');
                    const fullNameEl = document.getElementById('dropdown-full-name');
                    const emailEl = document.getElementById('dropdown-email');

                    if (firstNameEl) firstNameEl.innerText = data.firstName || "User";

                    if (initialsEl) {
                        initialsEl.innerText = ((data.firstName?.[0] || "") + (data.lastName?.[0] || "")).toUpperCase();
                    }

                    if (fullNameEl) fullNameEl.innerText = `${data.firstName} ${data.lastName}`;
                    if (emailEl) emailEl.innerText = user.email;

                    // Trigger Feather icons so the icons in the dropdown appear
                    if (window.feather) {
                        feather.replace();
                    }

                    // Hide Splash Screen
                    const splash = document.getElementById('splash-screen');
                    if (splash) {
                        // 1. Fade out (Opacity)
                        splash.classList.add('opacity-0');
                        // 2. Remove from display after the 700ms transition finishes
                        setTimeout(() => {
                            splash.style.display = 'none';
                        }, 700);
                    }
                }
            } else {
                // If not logged in, redirect to sign-in page
                window.location.href = "sign.html";
            }
        });

        // 4. Dealership Shop Policies Modal Logic ====
        import { dealershipPolicies } from "./components/data-content.js";

        // Ensure the DOM is fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {
            let activeShopType = "";
            const shopModal = document.getElementById('shop-modal');
            const modalTitle = document.getElementById('modal-shop-title');
            const modalDesc = document.getElementById('modal-shop-description');

            // Custom Dropdown Elements
            const dealerMenuBtn = document.getElementById('dealer-menu-button');
            const dealerDropdown = document.getElementById('dealer-dropdown');
            const dealerChevron = document.getElementById('dealer-chevron');
            const dealerText = document.getElementById('current-dealer-text');
            const dealerOptions = document.querySelectorAll('.dealer-option');

            // A. Toggle Custom Dropdown Menu with Safety Check
            if (dealerMenuBtn && dealerDropdown) {
                dealerMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // This is likely where your error was occurring
                    dealerDropdown.classList.toggle('hidden');
                    if (dealerChevron) dealerChevron.classList.toggle('rotate-180');
                });
            }

            // B. Handle Dealer Selection
            dealerOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const selectedValue = option.getAttribute('data-value');
                    if (dealerText) dealerText.innerText = selectedValue;

                    if (dealerDropdown) dealerDropdown.classList.add('hidden');
                    if (dealerChevron) dealerChevron.classList.remove('rotate-180');

                    updateModalContent(selectedValue);
                });
            });

            // C. Attach Click Events to Shop Cards
            document.querySelectorAll('.shop-card').forEach(card => {
                card.addEventListener('click', () => {
                    const titleEl = card.querySelector('.shop-title');
                    if (titleEl) {
                        activeShopType = titleEl.innerText.trim();
                        if (modalTitle) modalTitle.innerText = activeShopType;

                        const currentDealer = dealerText ? dealerText.innerText : "Hudson Honda";
                        updateModalContent(currentDealer);

                        if (shopModal) {
                            shopModal.classList.remove('hidden');
                            document.body.style.overflow = 'hidden';
                        }
                    }
                });
            });

            function updateModalContent(selectedDealer) {
                if (!modalDesc) return;
                const policy = dealershipPolicies[selectedDealer]?.[activeShopType] || "No policy data available.";
                modalDesc.innerHTML = policy;
            }

            // E. Close Logic
            const closeModal = () => {
                if (shopModal) {
                    shopModal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            };

            document.getElementById('close-shop-modal')?.addEventListener('click', closeModal);

            window.addEventListener('click', (e) => {
                // Close dropdown if user clicks outside
                if (dealerDropdown && !dealerDropdown.contains(e.target) && !dealerMenuBtn?.contains(e.target)) {
                    dealerDropdown.classList.add('hidden');
                    if (dealerChevron) dealerChevron.classList.remove('rotate-180');
                }
                if (e.target === shopModal) closeModal();
            });
        });
        // END of Dealership Shop Policies Modal Logic ====
    </script>
    <script src="./components/xtime-assessment-script.js"></script>
    <script type="module" src="./components/xtime-progress-tracker.js"></script>

</body>

</html>